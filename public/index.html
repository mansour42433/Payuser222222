<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .tab-btn { padding: 1rem; cursor: pointer; font-weight: bold; transition: all 0.2s; border-bottom: 4px solid transparent; }
        .tab-active { border-bottom-color: #2563eb; color: #1e40af; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { background-color: #ffffff; color: #374151; }
        
        .custom-table th { background-color: #1e40af; color: white; white-space: nowrap; }
        .custom-table tr:nth-child(even) { background-color: #f8fafc; }
        .custom-table tr:hover { background-color: #eff6ff; }
        
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* WhatsApp Filter Styles */
        .whatsapp-container { text-align: center; }
        .whatsapp-h2 { color: #075e54; margin-bottom: 20px; font-weight: bold; font-size: 1.5rem; }
        .whatsapp-textarea { width: 100%; height: 150px; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical; font-size: 16px; box-sizing: border-box; }
        .whatsapp-btn { background-color: #25d366; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: bold; transition: background 0.2s; }
        .whatsapp-btn:hover { background-color: #128c7e; }
        .whatsapp-copy-btn { background-color: #34b7f1; }
        .whatsapp-copy-btn:hover { background-color: #0d8ecf; }
        .whatsapp-output-area { margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 20px; }
        .whatsapp-note { font-size: 13px; color: #666; margin-bottom: 10px; text-align: right; background: #e8f5e9; padding: 8px; border-radius: 5px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loginScreen" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-gray-100">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</h2>
        <input type="password" id="appPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-4 border border-gray-300 rounded-xl mb-4 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
        <button onclick="checkPass()" id="loginBtn" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" class="text-red-500 mt-4 text-sm font-bold hidden bg-red-50 p-2 rounded">â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>

    <div id="mainApp" class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl hidden overflow-hidden border border-gray-200 flex flex-col min-h-[600px]">
        
        <header class="bg-white border-b sticky top-0 z-10">
            <div class="px-6 py-4 flex justify-between items-center bg-gray-50 border-b">
                <h1 class="text-xl font-extrabold text-gray-800 tracking-wide">Ù†Ø¸Ø§Ù… Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø´Ø§Ù…Ù„ <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">PRO v3.0</span></h1>
                <button onclick="logout()" class="text-red-500 text-sm font-bold hover:bg-red-50 px-4 py-2 rounded-lg transition border border-transparent hover:border-red-100">Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <div class="flex text-lg text-center bg-white shadow-sm">
                <div onclick="switchTab('whatsapp')" id="tab-whatsapp" class="tab-btn flex-1 tab-active">ğŸ“± Ù†Ø³Ø® Ù…Ù† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</div>
                <div onclick="switchTab('advanced')" id="tab-advanced" class="tab-btn flex-1 tab-inactive">ğŸ› ï¸ Ø¯ÙØ¹ Ù…ØªÙ‚Ø¯Ù…</div>
                <div onclick="switchTab('returns')" id="tab-returns" class="tab-btn flex-1 tab-inactive text-red-600">ğŸ”„ Ø¥Ø±Ø¬Ø§Ø¹ ÙÙˆØ§ØªÙŠØ±</div>
            </div>
        </header>

        <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
            
            <div class="mb-6 p-5 bg-white rounded-xl border border-gray-200 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-3">
                        <label class="block font-bold text-gray-700 text-sm mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                        <select id="invType" class="w-full p-3 border rounded-lg bg-gray-50 font-bold text-gray-700">
                            <option value="sales">ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                            <option value="purchases">ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                        </select>
                    </div>
                    <div class="md:col-span-9">
                        <label class="block font-bold text-gray-700 text-sm mb-2">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© / Ø§Ù„Ø¨Ù†Ùƒ</label>
                        <select id="bankAccount" class="w-full p-3 border rounded-lg bg-gray-50">
                            <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="view-whatsapp" class="block space-y-6 animate-fade-in">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm whatsapp-container">
                    <h2 class="whatsapp-h2">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h2>
                    <p class="whatsapp-note">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ù† ÙƒÙ„ Ø³Ø·Ø± ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ù…Ø«Ù„: Ø§Ù„ØºØ§Ø¡ØŒ ÙØ§ØªÙˆØ±Ø©ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®..).</p>

                    <label class="block font-bold text-gray-700 mb-2 text-right">Ø£Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§:</label>
                    <textarea id="whatsappInput" class="whatsapp-textarea" placeholder="[Ù¡Ù /Ù¡] Ø§Ù„Ø§Ø³Ù…: 4470&#10;Ø§Ù„ØºØ§Ø¡ 4585&#10;ÙØ§ØªÙˆØ±Ø© Ù…Ø­ÙˆÙ„Ù‡ 5464"></textarea>
                    
                    <div class="flex gap-2 justify-center">
                        <button onclick="extractNumbers()" class="whatsapp-btn">ØªØµÙÙŠØ© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
                        <button onclick="transferToAdvanced()" class="whatsapp-btn bg-blue-600 hover:bg-blue-700">Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… â¡ï¸</button>
                    </div>

                    <div class="whatsapp-output-area">
                        <label class="block font-bold text-gray-700 mb-2 text-right">Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØµØ§ÙÙŠØ©):</label>
                        <textarea id="whatsappOutput" class="whatsapp-textarea" readonly placeholder="Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø§ ØªØ­Øª Ø¨Ø¹Ø¶Ù‡Ø§..."></textarea>
                        <button class="whatsapp-btn whatsapp-copy-btn" onclick="copyWhatsappNumbers()">Ù†Ø³Ø® Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
                    </div>
                </div>
            </div>

            <div id="view-advanced" class="hidden animate-fade-in">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block font-bold text-gray-700">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±</label>
                                <div class="flex items-center gap-3">
                                    <button onclick="navigator.clipboard.readText().then(t=>{document.getElementById('advInputList').value=t.trim()})" class="text-blue-400 hover:text-blue-600 transition text-xs flex items-center gap-1 font-bold">ğŸ“‹ Ù„ØµÙ‚</button>
                                    <button onclick="document.getElementById('advInputList').value=''" class="text-gray-400 hover:text-red-500 transition text-xs flex items-center gap-1 font-bold">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
                                </div>
                            </div>
                            <textarea id="advInputList" class="w-full h-24 p-4 border rounded-xl font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ø¶Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø§..."></textarea>
                        </div>
                        <button onclick="fetchDetails()" class="md:h-24 md:w-40 w-full bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md transition flex flex-col items-center justify-center gap-2">
                            <span class="text-2xl">ğŸ“¥</span>
                            <span>Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span>
                        </button>
                    </div>
                </div>

                <div class="flex gap-2 mb-3">
                    <button onclick="filterAdvTable('all')" id="filterAll" class="filter-btn active-filter px-4 py-1.5 rounded-full text-sm font-bold bg-blue-600 text-white transition">Ø§Ù„ÙƒÙ„</button>
                    <button onclick="filterAdvTable('unpaid')" id="filterUnpaid" class="filter-btn px-4 py-1.5 rounded-full text-sm font-bold bg-white border border-gray-300 text-gray-600 hover:border-blue-400 transition">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© ÙÙ‚Ø·</button>
                    <button onclick="filterAdvTable('paid')" id="filterPaid" class="filter-btn px-4 py-1.5 rounded-full text-sm font-bold bg-white border border-gray-300 text-gray-600 hover:border-green-400 transition">Ù…Ø¯ÙÙˆØ¹Ø© ÙÙ‚Ø·</button>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right custom-table">
                            <thead>
                                <tr>
                                    <th class="p-4 w-12 text-center"><input type="checkbox" id="selectAllRows" checked class="w-5 h-5 accent-blue-600 cursor-pointer" onclick="toggleSelectAll(this)"></th>
                                    <th class="p-4">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                    <th class="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th class="p-4">Ø§Ù„Ù…Ù†Ø´Ø¦ / Ø§Ù„Ù…Ø®Ø²Ù†</th>
                                    <th class="p-4">Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                    <th class="p-4 w-40 text-center">Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø¯ÙØ¹</th>
                                    <th class="p-4 w-48 text-center">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
                                    <th class="p-4 w-48 text-center">Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="advTableBody" class="divide-y divide-gray-100">
                                <tr><td colspan="8" class="text-center p-8 text-gray-400 font-bold">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø«Ù… Ø§Ø¶ØºØ· "Ø¬Ù„Ø¨"</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 justify-between items-center bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 hidden" id="totalSection">
                    <div class="flex items-center gap-4">
                        <span class="text-blue-800 font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</span>
                        <span id="totalAmountDisplay" class="text-2xl font-black text-blue-900">0.00</span>
                        <span class="text-blue-700 font-bold">Ø±.Ø³</span>
                    </div>
                    <div class="flex gap-4">
                        <button id="btnExportExcel" onclick="exportToExcel()" class="bg-white text-green-700 border border-green-200 px-6 py-3 rounded-xl font-bold hover:bg-green-50 shadow-sm transition flex items-center gap-2">ğŸ“„ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø¥ÙƒØ³Ù„</button>
                        <button onclick="startPaymentAdvanced()" id="btnPayAdv" class="bg-gradient-to-r from-green-600 to-green-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-green-200 transition flex items-center gap-2 text-lg">ğŸ’¸ ØªØ£ÙƒÙŠØ¯ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm mt-4" id="historySection" style="display:none">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h4 class="font-bold text-gray-700">ğŸ“‹ Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                        <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-600 font-bold">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                    </div>
                    <div id="historyList" class="divide-y divide-gray-100 max-h-48 overflow-y-auto"></div>
                </div>
            </div>

            <div id="view-returns" class="hidden animate-fade-in">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6 flex items-start gap-3">
                    <span class="text-2xl">â„¹ï¸</span>
                    <div>
                        <h4 class="font-bold text-blue-900">Ø¢Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h4>
                        <p class="text-sm text-blue-700 mt-1">Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø¥Ù„ÙŠÙ‡.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-red-100 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 to-orange-400"></div>
                    <h3 class="font-bold text-red-800 text-xl mb-6 flex items-center gap-2">ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù† (Credit Note)</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</label>
                            <div class="flex gap-2">
                                <input type="text" id="returnRef" class="flex-1 p-3 border rounded-lg font-mono focus:ring-2 focus:ring-red-500 outline-none" placeholder="Ù…Ø«Ø§Ù„: INV-1001">
                                <button onclick="checkReturnInvoice()" class="bg-gray-800 text-white px-4 rounded-lg font-bold hover:bg-black transition">ÙØ­Øµ</button>
                            </div>
                            <div id="retStatusBox" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg"></div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
                            
                            <div class="flex gap-4">
                                <label class="flex items-center justify-center gap-2 cursor-pointer bg-blue-50 text-blue-800 p-3 rounded-xl border border-blue-200 shadow-sm hover:border-blue-500 transition-colors w-full">
                                    <input type="radio" name="returnTypeRadio" value="credit" checked onchange="setReturnType('credit')" class="w-5 h-5 text-blue-600">
                                    <span class="font-bold text-sm">ØªØ®ØµÙŠØµ (Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§)</span>
                                </label>
                                
                                <label class="flex items-center justify-center gap-2 cursor-pointer bg-white text-gray-600 p-3 rounded-xl border shadow-sm hover:border-green-500 transition-colors w-full">
                                    <input type="radio" name="returnTypeRadio" value="refund" onchange="setReturnType('refund')" class="w-5 h-5 text-green-600">
                                    <span class="font-bold text-sm">Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ</span>
                                </label>
                            </div>
                            
                            <input type="hidden" id="returnType" value="credit">
                            <p class="text-xs text-gray-500 mt-3 flex items-center gap-1">
                                <span id="returnHintBadge" class="w-2 h-2 rounded-full bg-orange-500 inline-block"></span>
                                <span id="returnHint">Ø³ÙŠØªÙ… Ø®ÙØ¶ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù„Ù† ÙŠØ®Ø±Ø¬ Ù…Ø§Ù„).</span>
                            </p>
                        </div>
                    </div>

                    <hr class="my-6 border-gray-100">
                    <button onclick="processReturn()" id="btnReturn" class="w-full bg-gradient-to-r from-red-600 to-red-500 text-white p-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-red-200 hover:-translate-y-0.5 transition">ğŸš€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„</button>
                    <div id="returnLog" class="mt-4"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. SETUP ---
        let userToken = localStorage.getItem("qoyod_app_pass") || "";
        let advData = [];

        if(userToken) verifyAndLogin();

        async function secureFetch(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers['Content-Type'] = 'application/json';
            options.headers['x-app-password'] = userToken;
            try {
                const res = await fetch(url, options);
                if (res.status === 401) { logout(); throw new Error("Auth"); }
                return res;
            } catch (e) {
                throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        }

        async function checkPass(){
            const pass = document.getElementById("appPass").value;
            const btn = document.getElementById("loginBtn");
            const err = document.getElementById("loginError");
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚..."; btn.disabled = true; err.classList.add("hidden");
            try {
                const res = await fetch('/api/login', { method: 'POST', headers: {'x-app-password': pass} });
                if(res.ok) { userToken = pass; localStorage.setItem("qoyod_app_pass", pass); showApp(); } 
                else { err.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©"; err.classList.remove("hidden"); }
            } catch(e) { err.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"; err.classList.remove("hidden"); }
            btn.innerText = "Ø¯Ø®ÙˆÙ„"; btn.disabled = false;
        }

        function showApp(){ 
            document.getElementById("loginScreen").classList.add("hidden"); 
            document.getElementById("mainApp").classList.remove("hidden");
            loadAccounts();
        }
        function logout(){ localStorage.removeItem("qoyod_app_pass"); location.reload(); }
        function verifyAndLogin() { loadAccounts(); showApp(); }

        async function loadAccounts(){
            try {
                const res = await secureFetch('/api/accounts');
                const list = await res.json();
                const sel = document.getElementById("bankAccount");
                sel.innerHTML = "";
                list.forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.id; opt.text = a.name; sel.appendChild(opt);
                });

                // ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
                const savedDefaultAccount = localStorage.getItem('defaultPayAccount');
                if (savedDefaultAccount) {
                    sel.value = savedDefaultAccount;
                }

                // ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ ÙÙˆØ±Ø§Ù‹ Ø¨Ù…Ø¬Ø±Ø¯ Ø£Ù† ÙŠØºÙŠØ±Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                sel.addEventListener('change', (e) => {
                    localStorage.setItem('defaultPayAccount', e.target.value);
                });

            } catch(e){}
        }

        function switchTab(t){
            ['whatsapp','advanced','returns'].forEach(x => {
                document.getElementById('view-'+x).classList.add('hidden');
                document.getElementById('tab-'+x).className = "tab-btn flex-1 tab-inactive";
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).className = `tab-btn flex-1 tab-active ${t==='returns'?'text-red-700 border-red-500 bg-red-50':''}`;
        }

        // --- 2. WHATSAPP FILTER LOGIC ---
        function extractNumbers() {
            const text = document.getElementById("whatsappInput").value;
            const lines = text.split('\n');
            let extractedNumbers = [];
            lines.forEach(line => {
                const matches = line.match(/[0-9]+/g);
                if (matches && matches.length > 0) {
                    const lastNumber = matches[matches.length - 1];
                    extractedNumbers.push(lastNumber);
                }
            });
            document.getElementById("whatsappOutput").value = extractedNumbers.join('\n');
        }

        function copyWhatsappNumbers() {
            const outputText = document.getElementById("whatsappOutput");
            if(!outputText.value) return;
            outputText.select();
            navigator.clipboard.writeText(outputText.value).then(() => {
                alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø£Ø±Ù‚Ø§Ù…!");
            });
        }

        function transferToAdvanced() {
            const numbers = document.getElementById("whatsappOutput").value;
            if(!numbers) {
                alert("Ù‚Ù… Ø¨Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            document.getElementById("advInputList").value = numbers;
            switchTab('advanced');
        }

        // --- 3. ADVANCED PAY LOGIC ---
        async function fetchDetails(){
            const rawText = document.getElementById("advInputList").value;
            const lines = rawText.split('\n').filter(x=>x.trim());
            if(lines.length === 0) return alert("Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙˆØ§ØªÙŠØ± Ø£ÙˆÙ„Ø§Ù‹");

            const type = document.getElementById("invType").value;
            const tbody = document.getElementById("advTableBody"); 
            tbody.innerHTML = "<tr><td colspan='8' class='text-center p-8'><span class='text-blue-600 font-bold text-xl animate-pulse'>â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚ÙŠÙˆØ¯...</span></td></tr>";
            
            advData = [];
            for(let line of lines) {
                let ref = line.trim();
                // Add prefix if it's just a number
                if(/^\d+$/.test(ref)) {
                    ref = (type === 'sales' ? 'INV' : 'BILL-') + ref;
                }
                try {
                    const res = await secureFetch('/api/preview', { method: 'POST', body: JSON.stringify({type, ref}) });
                    const d = await res.json();
                    advData.push({ref, data: d});
                } catch(e) { advData.push({ref, data: {status:'error'}}); }
            }
            renderAdvTable();
            document.getElementById("totalSection").classList.remove("hidden");
            updateTotalAmount();
        }

        function renderAdvTable(){
            const tbody = document.getElementById("advTableBody"); tbody.innerHTML = "";
            const today = new Date().toISOString().split('T')[0];

            if(advData.length === 0) { tbody.innerHTML = "<tr><td colspan='8' class='text-center p-4 text-gray-400'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>"; return; }

            advData.forEach((row, i) => {
                const d = row.data;
                if(d.status === 'not_found' || d.status === 'error') {
                    tbody.innerHTML += `<tr class="bg-red-50 border-b border-red-100"><td class="p-4 text-center"><input type="checkbox" disabled class="w-4 h-4"></td><td class="p-4 font-mono font-bold text-red-600">${row.ref}</td><td colspan="6" class="p-4 text-red-500 font-bold text-center">âŒ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù‚Ù…</td></tr>`;
                    return;
                }
                const isPaid = d.inv_status === 'Paid';
                const rowClass = isPaid ? "bg-gray-50 opacity-75" : "bg-white";
                let statusBadge = "";
                if (row.result) {
                    if (row.result.status === 'success') statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">âœ… ØªÙ… (${row.result.amount})</span>`;
                    else statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">âŒ ÙØ´Ù„</span>`;
                } else {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isPaid?'bg-green-100 text-green-800':'bg-blue-100 text-blue-800'} border border-gray-200">${d.inv_status}</span>`;
                }

                tbody.innerHTML += `
                    <tr class="${rowClass} border-b border-gray-100 transition hover:bg-blue-50/30" data-status="${isPaid?'paid':'unpaid'}">
                        <td class="p-4 text-center"><input type="checkbox" class="chk-row w-5 h-5 accent-blue-600" data-idx="${i}" ${isPaid?'disabled':'checked'} onchange="updateTotalAmount()"></td>
                        <td class="p-4 font-mono font-bold text-gray-700">${d.ref}</td>
                        <td class="p-4 font-bold text-gray-800">${d.contact}</td>
                        <td class="p-4 text-sm">
                            <div class="font-bold text-blue-700">${d.user_name}</div>
                            <div class="text-gray-500 text-xs">${d.inventory_name}</div>
                        </td>
                        <td class="p-4 font-bold text-red-600">${d.due}</td>
                        <td class="p-4"><input type="number" value="${d.due}" class="amt-in w-full p-2 border rounded text-center font-bold focus:ring-2 focus:ring-blue-500" data-idx="${i}" ${isPaid?'disabled':''} oninput="updateTotalAmount()"></td>
                        <td class="p-4"><input type="date" value="${today}" class="date-in w-full p-2 border rounded text-sm font-bold" data-idx="${i}" ${isPaid?'disabled':''}></td>
                        <td class="p-4 text-center font-bold">${statusBadge}</td>
                    </tr>
                `;
            });
        }

        async function startPaymentAdvanced(){
            const acc = document.getElementById("bankAccount").value;
            const type = document.getElementById("invType").value;
            const chks = document.querySelectorAll(".chk-row:checked");
            if(chks.length === 0) return alert("âš ï¸ Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ÙØ§ØªÙˆØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¯ÙØ¹!");
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¯ÙØ¹ Ù…Ø¨Ù„Øº ${chks.length} ÙØ§ØªÙˆØ±Ø©ØŸ`)) return;

            const btn = document.getElementById("btnPayAdv"); btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°..."; btn.disabled = true;
            for(let chk of chks) {
                const i = chk.dataset.idx;
                const amt = document.querySelector(`.amt-in[data-idx="${i}"]`).value;
                const date = document.querySelector(`.date-in[data-idx="${i}"]`).value;
                advData[i].result = null; 
                try {
                    const res = await secureFetch('/api/pay', { method: 'POST', body: JSON.stringify({type, ref: advData[i].ref, accountId: acc, forceAmount: amt, forceDate: date}) });
                    const data = await res.json();
                    advData[i].result = data;
                } catch(e) { advData[i].result = {status:'error', details:'Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'}; }
            }
            btn.innerText = "ğŸ’¸ ØªØ£ÙƒÙŠØ¯ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹"; btn.disabled = false;
            renderAdvTable();
            alert("âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©! Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
        }

        function toggleSelectAll(master) {
            const checkboxes = document.querySelectorAll('.chk-row:not(:disabled)');
            checkboxes.forEach(chk => chk.checked = master.checked);
            updateTotalAmount();
        }

        function updateTotalAmount() {
            let total = 0;
            const rows = document.querySelectorAll('.chk-row:checked');
            rows.forEach(chk => {
                const idx = chk.dataset.idx;
                const amtInput = document.querySelector(`.amt-in[data-idx="${idx}"]`);
                if (amtInput) {
                    total += parseFloat(amtInput.value || 0);
                }
            });
            document.getElementById('totalAmountDisplay').innerText = total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function exportToExcel() {
            if(advData.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
            const data = advData.map(item => {
                const res = item.result || {};
                let status = "Ù„Ù… ÙŠØªÙ…";
                if(item.data.inv_status === 'Paid') status = "Ù…Ø¯ÙÙˆØ¹Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹";
                else if(res.status === 'success') status = "ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­";
                else if(res.status === 'error') status = "ÙØ´Ù„: " + (res.details || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
                return { "Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©": item.ref, "Ø§Ù„Ø¹Ù…ÙŠÙ„": item.data.contact || '-', "Ø§Ù„Ù…Ù†Ø´Ø¦": item.data.user_name, "Ø§Ù„Ù…Ø®Ø²Ù†": item.data.inventory_name, "Ø§Ù„Ù…Ø³ØªØ­Ù‚": item.data.due || 0, "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹": res.amount || 0, "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©": res.date || '-', "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©": status };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª");
            XLSX.writeFile(wb, "Qoyod_Payment_Report.xlsx");
        }

        // --- 4. RETURNS LOGIC ---
        async function checkReturnInvoice() {
            let ref = document.getElementById("returnRef").value;
            if(!ref) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
            const statusBox = document.getElementById("retStatusBox");
            statusBox.innerHTML = `<div class="text-center text-blue-600 py-4 font-bold animate-pulse">â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø©...</div>`;
            statusBox.classList.remove("hidden");

            try {
                const res = await secureFetch('/api/preview', { method: 'POST', body: JSON.stringify({type:'sales', ref}) });
                const d = await res.json();

                if(d.status === 'found') {
                    const isPaid = (d.inv_status === 'Paid');
                    setReturnType(isPaid ? 'refund' : 'credit');
                    statusBox.innerHTML = `
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                            <span class="text-sm text-gray-500">Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                            <b class="text-gray-900">${d.contact}</b>
                        </div>
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                            <span class="text-sm text-gray-500">Ø§Ù„Ù…Ù†Ø´Ø¦ / Ø§Ù„Ù…Ø®Ø²Ù†</span>
                            <div class="text-right">
                                <div class="text-xs font-bold text-blue-700">${d.user_name}</div>
                                <div class="text-[10px] text-gray-500">${d.inventory_name}</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-500">Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span>
                            <b class="${isPaid ? 'text-green-600' : 'text-orange-500'}">${d.inv_status}</b>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                            <b class="text-gray-900">${d.total}</b>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-500">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                            <b class="text-red-600">${d.due}</b>
                        </div>
                    `;
                } else if (d.status === 'not_found') {
                    statusBox.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded text-center font-bold">âŒ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>`;
                } else {
                    statusBox.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded text-center">âŒ Ø®Ø·Ø£: ${d.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>`;
                }
            } catch(e) { 
                statusBox.innerHTML = `<div class="text-red-600 text-center p-4 bg-red-50 rounded">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>`; 
            }
        }

        function toggleAccountSelect() {
            const type = document.getElementById("returnType").value;
            const hintText = document.getElementById("returnHint");
            const hintBadge = document.getElementById("returnHintBadge");
            if(type === 'credit') {
                hintText.innerText = "Ø³ÙŠØªÙ… Ø®ÙØ¶ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù„Ù† ÙŠØ®Ø±Ø¬ Ù…Ø§Ù„).";
                hintBadge.className = "w-2 h-2 rounded-full bg-orange-500 inline-block";
            } else {
                hintText.innerText = "Ø³ÙŠØªÙ… Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.";
                hintBadge.className = "w-2 h-2 rounded-full bg-green-500 inline-block";
            }
        }

        async function processReturn() {
            let ref = document.getElementById("returnRef").value;
            if(!ref) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
            const type = document.getElementById("returnType").value;
            const acc = document.getElementById("bankAccount").value;
            
            if(!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${ref} Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;

            const btn = document.getElementById("btnReturn");
            const log = document.getElementById("returnLog");
            btn.disabled = true; btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
            
            try {
                const res = await secureFetch('/api/return', { method: 'POST', body: JSON.stringify({ ref, returnType: type, accountId: acc }) });
                const data = await res.json();
                if(data.status === 'success') {
                    const cnMatch = data.message.match(/CRN[\w\-]+/);
                    const cnRef = cnMatch ? cnMatch[0] : '';
                    log.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-3xl">âœ…</span>
                                <div><h4 class="font-bold text-green-800">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</h4><p class="text-sm text-green-700">${data.message}</p></div>
                            </div>
                            ${cnRef ? `<div class="bg-white border border-green-300 rounded-lg p-3 flex justify-between items-center">
                                <span class="text-sm text-gray-500">Ø±Ù‚Ù… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù†</span>
                                <div class="flex items-center gap-2">
                                    <b class="font-mono text-green-800 text-lg">${cnRef}</b>
                                    <button onclick="navigator.clipboard.writeText('${cnRef}');this.innerText='âœ…';setTimeout(()=>this.innerText='Ù†Ø³Ø®',1500)" class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition">Ù†Ø³Ø®</button>
                                </div>
                            </div>` : ''}
                        </div>`;
                    saveToHistory({ref, type, cnRef, status:'success', time: new Date().toLocaleString('ar-SA')});
                } else {
                    log.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-xl border border-red-200"><h4 class="font-bold flex items-center gap-2">âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</h4><p class="text-sm mt-1">${data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p></div>`;
                    saveToHistory({ref, type, cnRef:'', status:'fail', time: new Date().toLocaleString('ar-SA')});
                }
            } catch(e) { log.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-xl border border-red-200">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>`; }
            btn.disabled = false; btn.innerText = "ğŸš€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„";
        }

        // ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ù…Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙƒÙ€ Radio Buttons 
        function setReturnType(type) {
            document.getElementById('returnType').value = type;
            const radios = document.getElementsByName('returnTypeRadio');
            radios.forEach(radio => {
                if(radio.value === type) {
                    radio.checked = true;
                    // ØªØºÙŠÙŠØ± Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø·
                    radio.parentElement.className = radio.parentElement.className.replace('bg-white text-gray-600', 'bg-blue-50 text-blue-800 border-blue-200');
                } else {
                    radio.parentElement.className = radio.parentElement.className.replace('bg-blue-50 text-blue-800 border-blue-200', 'bg-white text-gray-600');
                }
            });
            toggleAccountSelect();
        }

        // ÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let currentFilter = 'all';
        function filterAdvTable(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.className = b.className.replace('bg-blue-600 text-white','bg-white border border-gray-300 text-gray-600');
            });
            const active = document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1));
            if(active) active.className = active.className.replace('bg-white border border-gray-300 text-gray-600','bg-blue-600 text-white');
            document.querySelectorAll('#advTableBody tr[data-status]').forEach(row => {
                const s = row.dataset.status;
                if(filter === 'all') row.style.display = '';
                else if(filter === 'unpaid') row.style.display = s === 'unpaid' ? '' : 'none';
                else if(filter === 'paid') row.style.display = s === 'paid' ? '' : 'none';
            });
        }

        // Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        function saveToHistory(entry) {
            let hist = JSON.parse(localStorage.getItem('returnHistory') || '[]');
            hist.unshift(entry);
            if(hist.length > 20) hist = hist.slice(0, 20);
            localStorage.setItem('returnHistory', JSON.stringify(hist));
            renderHistory();
        }
        function renderHistory() {
            const hist = JSON.parse(localStorage.getItem('returnHistory') || '[]');
            const sec = document.getElementById('historySection');
            const list = document.getElementById('historyList');
            if(hist.length === 0) { sec.style.display='none'; return; }
            sec.style.display = 'block';
            list.innerHTML = hist.map(h => `
                <div class="flex justify-between items-center p-3 text-sm">
                    <div class="flex items-center gap-2">
                        <span>${h.status==='success'?'âœ…':'âŒ'}</span>
                        <span class="font-mono font-bold text-gray-700">${h.ref}</span>
                        <span class="text-gray-400 text-xs">${h.type==='refund'?'Ø§Ø³ØªØ±Ø¯Ø§Ø¯':'ØªØ®ØµÙŠØµ'}</span>
                        ${h.cnRef ? `<span class="font-mono text-green-700 text-xs bg-green-50 px-2 py-0.5 rounded">${h.cnRef}</span>` : ''}
                    </div>
                    <span class="text-gray-400 text-xs">${h.time}</span>
                </div>`).join('');
        }
        function clearHistory() {
            localStorage.removeItem('returnHistory');
            renderHistory();
        }
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        renderHistory();

    </script>
</body>
</html>
